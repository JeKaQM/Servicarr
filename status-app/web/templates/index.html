<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <title>Service Status</title>
  <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg"/>
  <meta name="theme-color" content="#0c121c"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="stylesheet" href="/static/css/main.css"/>
  <link rel="stylesheet" href="/static/css/blocks.css"/>
  <!-- Load utils first, without defer -->
  <script src="/static/js/utils.js"></script>
  <!-- Then load other scripts with defer -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="/static/js/app.js" defer></script>
  <script src="/static/js/blocks.js" defer></script>
</head>
<body>
  <header>
    <div class="brand">
      <h1>Service Status</h1>
      <small>Updated <span id="updated">—</span></small>
    </div>
    <div class="user">
      <span id="welcome" class="muted">Public view</span>
      <button id="loginBtn" class="ghost">Login</button>
      <button id="logoutBtn" class="ghost hidden">Logout</button>
    </div>
  </header>

  <main>
    <section class="card" id="card-server" data-key="server">
      <div class="row">
        <div class="row-left">
          <img src="/static/images/server.svg" class="icon" alt="Server"/>
          <div><strong>Server</strong><div class="label">Reachability</div></div>
        </div>
        <span class="pill warn">—</span>
      </div>
      <div class="row kpirow"><div class="kpi">—</div><div class="label">—</div></div>
      <div class="row adminRow hidden">
        <div class="label">Admin</div>
        <div class="ops">
          <button class="btn mini checkNow">Check now</button>
          <label class="toggle">
            <input type="checkbox" class="monitorToggle" checked>
            <span class="slider"></span>
            <span class="toggleLabel">Monitor</span>
          </label>
        </div>
      </div>
    </section>

    <section class="card" id="card-plex" data-key="plex">
      <div class="row">
        <div class="row-left">
          <img src="/static/images/plex.svg" class="icon" alt="Plex"/>
          <div><strong>Plex</strong><div class="label">/identity</div></div>
        </div>
        <span class="pill warn">—</span>
      </div>
      <div class="row kpirow"><div class="kpi">—</div><div class="label">—</div></div>
      <div class="row adminRow hidden">
        <div class="label">Admin</div>
        <div class="ops">
          <button class="btn mini checkNow">Check now</button>
          <label class="toggle">
            <input type="checkbox" class="monitorToggle" checked>
            <span class="slider"></span>
            <span class="toggleLabel">Monitor</span>
          </label>
        </div>
      </div>
    </section>

    <section class="card" id="card-overseerr" data-key="overseerr">
      <div class="row">
        <div class="row-left">
          <img src="/static/images/overseerr.svg" class="icon" alt="Overseerr"/>
          <div><strong>Overseerr</strong><div class="label">/api/v1/status</div></div>
        </div>
        <span class="pill warn">—</span>
      </div>
      <div class="row kpirow"><div class="kpi">—</div><div class="label">—</div></div>
      <div class="row adminRow hidden">
        <div class="label">Admin</div>
        <div class="ops">
          <button class="btn mini checkNow">Check now</button>
          <label class="toggle">
            <input type="checkbox" class="monitorToggle" checked>
            <span class="slider"></span>
            <span class="toggleLabel">Monitor</span>
          </label>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row"><div><strong>Recent incidents</strong><div class="label">Last 24h</div></div></div>
      <ul id="incidents"></ul>
    </section>
  </main>

  <!-- Full-width Uptime Section -->
  <section class="card uptime-section">
    <div class="row">
      <div>
        <strong>Uptime</strong>
        <div class="label" id="window">Last 30 days</div>
      </div>
      <select id="uptimeFilter" class="uptime-filter">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="180">Last 180 days</option>
        <option value="360">Last 360 days</option>
      </select>
    </div>
    
    <!-- Server Uptime Bar -->
    <div class="service-uptime">
      <div class="service-uptime-header">
        <span class="service-name">Server</span>
        <span class="protocol-badge">TCP</span>
        <span class="uptime-percent" id="uptime-server">—%</span>
      </div>
      <div class="uptime-bar-container">
        <div class="uptime-bar" id="uptime-bar-server"></div>
      </div>
    </div>

    <!-- Plex Uptime Bar -->
    <div class="service-uptime">
      <div class="service-uptime-header">
        <span class="service-name">Plex</span>
        <span class="protocol-badge">HTTPS</span>
        <span class="uptime-percent" id="uptime-plex">—%</span>
      </div>
      <div class="uptime-bar-container">
        <div class="uptime-bar" id="uptime-bar-plex"></div>
      </div>
    </div>

    <!-- Overseerr Uptime Bar -->
    <div class="service-uptime">
      <div class="service-uptime-header">
        <span class="service-name">Overseerr</span>
        <span class="protocol-badge">HTTPS</span>
        <span class="uptime-percent" id="uptime-overseerr">—%</span>
      </div>
      <div class="uptime-bar-container">
        <div class="uptime-bar" id="uptime-bar-overseerr"></div>
      </div>
    </div>
    
    <div class="uptime-footer">
      <span class="uptime-timestamp" id="timestamp-global">—</span>
    </div>
  </section>

  <!-- Discreet login modal -->
  <dialog id="loginModal">
    <form class="login">
      <div>
        <h3>Sign in</h3>
        <p class="muted">Enter your credentials</p>
      </div>
      <div>
        <label for="u">Username</label>
        <input id="u" type="text" autocomplete="username" placeholder="admin" required>
      </div>
      <div>
        <label for="p">Password</label>
        <input id="p" type="password" autocomplete="current-password" placeholder="••••••••" required>
      </div>
      <div id="loginError" class="error hidden"></div>
      <div class="actions">
        <button id="doLogin" class="btn" type="button">Login</button>
        <button id="cancelLogin" class="ghost" type="button">Cancel</button>
      </div>
    </form>
  </dialog>

  <!-- Admin Panel with Tabs -->
  <section id="adminPanel" class="card admin-panel admin hidden">
    <div class="admin-tabs">
      <button class="tab-btn active" data-tab="main">Main</button>
      <button class="tab-btn" data-tab="security">Security</button>
      <button class="tab-btn" data-tab="alerts">Alerts</button>
    </div>

    <!-- Main Tab -->
    <div id="tab-main" class="tab-content active">
      <h2>Admin Controls</h2>
      <div class="admin-section">
        <h3>Service Management</h3>
        <p class="muted">Quick actions for all services</p>
        <div class="ops">
          <button id="ingestNowTab" class="btn">Check All Services Now</button>
          <button id="resetRecentTab" class="btn danger">Reset Recent Incidents</button>
        </div>
      </div>
    </div>

    <!-- Security Tab -->
    <div id="tab-security" class="tab-content">
      <div class="blocks-header">
        <h2>IP Block Management</h2>
        <button id="resetBlocks" class="btn danger">Clear All Blocks</button>
      </div>
      <div id="blocksList" class="blocks-list">
        <div class="muted">Loading...</div>
      </div>
    </div>

    <!-- Alerts Tab -->
    <div id="tab-alerts" class="tab-content">
      <h2>Email Alerts Configuration</h2>
      <p class="muted">Send email notifications when service status changes</p>
      
      <div class="admin-section">
        <h3>SMTP Settings</h3>
        <form id="alertsForm">
          <div class="form-group">
            <label for="alertsEnabled">
              <input type="checkbox" id="alertsEnabled"> Enable email alerts
            </label>
          </div>
          
          <div class="form-group">
            <label for="smtpHost">SMTP Host</label>
            <input type="text" id="smtpHost" placeholder="smtp.gmail.com" />
          </div>
          
          <div class="form-group">
            <label for="smtpPort">SMTP Port</label>
            <input type="number" id="smtpPort" placeholder="587" />
          </div>
          
          <div class="form-group">
            <label for="smtpUser">SMTP Username</label>
            <input type="text" id="smtpUser" placeholder="your-email@example.com" />
          </div>
          
          <div class="form-group">
            <label for="smtpPassword">SMTP Password</label>
            <input type="password" id="smtpPassword" placeholder="••••••••" />
          </div>
          
          <div class="form-group">
            <label for="alertEmail">Alert Email (To)</label>
            <input type="email" id="alertEmail" placeholder="admin@example.com" />
          </div>
          
          <div class="form-group">
            <label for="alertFromEmail">From Email</label>
            <input type="email" id="alertFromEmail" placeholder="alerts@example.com" />
          </div>
          
          <div class="form-group">
            <h4>Alert Conditions</h4>
            <label>
              <input type="checkbox" id="alertOnDown" checked> Alert when service goes DOWN
            </label>
            <label>
              <input type="checkbox" id="alertOnDegraded" checked> Alert when service becomes DEGRADED
            </label>
            <label>
              <input type="checkbox" id="alertOnUp"> Alert when service comes back UP
            </label>
          </div>
          
          <div class="ops">
            <button type="button" id="saveAlerts" class="btn">Save Configuration</button>
            <button type="button" id="testEmail" class="btn ghost">Send Test Email</button>
          </div>
          
          <div id="alertStatus" class="status-message hidden"></div>
        </form>
      </div>
    </div>
  </section>

  <footer>Auto-refreshing every 15s. Metrics need a few minutes to populate.</footer>
</body>
</html>